---
import BaseLayout from "../layouts/BaseLayout.astro";

// Estructura:
// - Comunicados (IMÁGENES):  1CNombre.jpg|png|webp
// - Asambleas (PDF):         1ANombre.pdf

const comunicadoImgs = import.meta.glob("/src/assets/documentos/*.{jpg,jpeg,png,webp}", { eager: true, as: "url" });
const asambleaPdfs   = import.meta.glob("/src/assets/documentos/*.{pdf,PDF}",           { eager: true, as: "url" });

function toTitle(file: any) {
  const s = file.replace(/\.(pdf|PDF|jpg|jpeg|png|webp)$/i, "").replace(/^(\d+)[CA]/i, "");
  return s.replace(/[-_]+/g, " ").trim();
}

function buildItemsFromImages(map: any) {
  return Object.entries(map).map(([path, url]) => {
    const file = (path.split("/").pop() || "");
    const base = file.replace(/\.(jpg|jpeg|png|webp)$/i, "");
    const m = /^(\d+)([CA])(.+)$/.exec(base);
    if (!m) return null;
    return {
      url,
      order: parseInt(m[1], 10),
      type: m[2].toUpperCase(), // "C" o "A"
      title: toTitle(file) || base,
      kind: "image",
    };
  }).filter(Boolean);
}

function buildItemsFromPdfs(map: any) {
  return Object.entries(map).map(([path, url]) => {
    const file = (path.split("/").pop() || "");
    const base = file.replace(/\.(pdf|PDF)$/i, "");
    const m = /^(\d+)([CA])(.+)$/.exec(base);
    return {
      url,
      order: m ? parseInt(m[1], 10) : 9999,
      type: m ? m[2].toUpperCase() : "A",
      title: toTitle(file) || base,
      kind: "pdf",
    };
  });
}

const imgItems = buildItemsFromImages(comunicadoImgs);
const pdfItems = buildItemsFromPdfs(asambleaPdfs);

const comunicados = imgItems
  .filter(d => d && d.type === "C")
  .sort((a,b) => a!.order - b!.order);

const asambleas  = pdfItems
  .filter(d => d.type === "A")
  .sort((a,b) => a.order - b.order);

const loop = (arr: any) => [...arr, ...arr];
---

<BaseLayout title="Documentos">
  <section class="mx-auto max-w-7xl px-4 py-10 md:py-14">
    <h1 class="text-3xl md:text-4xl font-bold tracking-tight">Documentos</h1>
    <p class="mt-2 text-neutral-600">Coloca el cursor sobre un documento para pausar el carrusel y verlo mejor.</p>

    <!-- Comunicados y Avisos (der -> izq) -->
    <div class="mt-8 md:mt-12">
      <div class="flex items-baseline justify-between">
        <h2 class="text-xl md:text-2xl font-semibold">Comunicados y Avisos</h2>
        <span class="text-xs uppercase tracking-wide text-neutral-500">Imágenes • Orden por prefijo</span>
      </div>

      <!-- SIN class="group" aquí para que sólo crezca el título del ítem hover -->
      <div class="marquee-container relative mt-4 overflow-x-hidden overflow-y-visible pt-8 pb-6">
        <div class="fade-left pointer-events-none"></div>
        <div class="fade-right pointer-events-none"></div>

        <div class="marquee-track marquee-left w-max flex gap-6 px-6">
          { loop(comunicados).map((d) => (
            <a
              href={d.url}
              target="_blank"
              rel="noopener noreferrer"
              class="doc-card group relative w-44 md:w-56 shrink-0 hover:z-20"
              aria-label={d.title}
              title={d.title}
            >
              <div class="card-root relative ar-3-4 overflow-hidden rounded-2xl shadow-md ring-1 ring-black/10 bg-white transition-transform duration-300 ease-out origin-top group-hover:scale-[1.05] group-hover:-translate-y-1">
                <img src={d.url} alt={d.title} class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105" />
                <span class="absolute left-2 top-2 inline-flex h-6 px-2 items-center rounded-md bg-neutral-900/85 text-white text-[11px] font-semibold tracking-wide">C</span>
              </div>
              <!-- Sólo el título del ítem hover crece -->
              <div class="mt-2 text-sm font-medium text-neutral-800 clamp-2 transition-all duration-200 ease-out group-hover:mt-3 group-hover:text-base group-hover:font-semibold">
                {d.title}
              </div>
            </a>
          )) }
        </div>
      </div>

      { comunicados.length === 0 && (
        <p class="mt-3 text-sm text-neutral-500">
          Agrega <strong>imágenes</strong> como <code class="font-mono">1CNombre.jpg</code> (o .png/.webp) en <code class="font-mono">src/assets/documentos/</code>.
        </p>
      ) }
    </div>

    <!-- Asambleas y Acuerdos (izq -> der) -->
    <div class="mt-10 md:mt-14">
      <div class="flex items-baseline justify-between">
        <h2 class="text-xl md:text-2xl font-semibold">Asambleas y Acuerdos</h2>
        <span class="text-xs uppercase tracking-wide text-neutral-500">PDF • Orden por prefijo</span>
      </div>

      <div class="marquee-container relative mt-4 overflow-x-hidden overflow-y-visible pt-8 pb-6">
        <div class="fade-left pointer-events-none"></div>
        <div class="fade-right pointer-events-none"></div>

        <div class="marquee-track marquee-right w-max flex gap-6 px-6">
          { loop(asambleas).map((d) => (
            <a
              href={d.url}
              target="_blank"
              rel="noopener noreferrer"
              class="doc-card group relative w-44 md:w-56 shrink-0 hover:z-20"
              aria-label={d.title}
              title={d.title}
            >
              <div class="card-root relative ar-3-4 overflow-hidden rounded-2xl shadow-md ring-1 ring-black/10 bg-white transition-transform duration-300 ease-out origin-top group-hover:scale-[1.05] group-hover:-translate-y-1">
                <div class="absolute inset-0 bg-gradient-to-br from-[#fef2df] to-[#ffedd5]"></div>
                <div class="absolute inset-0 p-3 flex flex-col">
                  <div class="self-start rounded-md bg-red-600 text-white text-[11px] font-semibold px-2 py-1 shadow">PDF</div>
                  <div class="mt-auto text-neutral-800 text-sm font-semibold leading-snug">{d.title}</div>
                </div>
              </div>
              <div class="mt-2 text-sm font-medium text-neutral-800 clamp-2 transition-all duration-200 ease-out group-hover:mt-3 group-hover:text-base group-hover:font-semibold">
                {d.title}
              </div>
            </a>
          )) }
        </div>
      </div>

      { asambleas.length === 0 && (
        <p class="mt-3 text-sm text-neutral-500">
          Agrega <code class="font-mono">1ANombre.pdf</code> en <code class="font-mono">src/assets/documentos/</code>.
        </p>
      ) }
    </div>
  </section>

  <style is:global>
    :root{
      --marquee-speed-left: 38s;
      --marquee-speed-right: 44s;
      --fade-bg: #fff; /* cambia si tu fondo no es blanco */
    }

    @keyframes marquee-left { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }
    @keyframes marquee-right{ 0%{transform:translateX(-50%)} 100%{transform:translateX(0)} }
    .marquee-left  { animation: marquee-left  var(--marquee-speed-left)  linear infinite; }
    .marquee-right { animation: marquee-right var(--marquee-speed-right) linear infinite; }

    .marquee-container:hover .marquee-track { animation-play-state: paused; }

    .fade-left,
    .fade-right{
      position: absolute;
      top: 0; bottom: 0;
      width: 80px;
      z-index: 10;
      pointer-events: none;
    }
    .fade-left  { left: 0;  background: linear-gradient(to right, var(--fade-bg) 0%, rgba(255,255,255,0) 100%); }
    .fade-right { right: 0; background: linear-gradient(to left,  var(--fade-bg) 0%, rgba(255,255,255,0) 100%); }

    .ar-3-4 { aspect-ratio: 3/4; }
    .clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</BaseLayout>
